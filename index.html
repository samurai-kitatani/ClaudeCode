<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>„Ç´„Çø„É≥ „Ç≤„Éº„É†„Éû„Çπ„Çø„Éº</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-bottom: 70px;
        }

        .container {
            background: white;
            min-height: 100vh;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header h1 {
            font-size: clamp(1.3em, 5vw, 1.6em);
            margin-bottom: 5px;
        }

        .voice-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
        }

        .voice-toggle.on {
            background: #27ae60;
        }

        .voice-input-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
            width: 100%;
            max-width: 300px;
            margin: 10px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .voice-input-btn.listening {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            animation: pulse-mic 1.5s infinite;
        }

        @keyframes pulse-mic {
            0%, 100% { box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4); }
            50% { box-shadow: 0 5px 25px rgba(39, 174, 96, 0.8); }
        }

        .voice-status {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            min-height: 40px;
            text-align: center;
            color: #6c757d;
            font-size: 0.9em;
        }

        .voice-help {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 0.85em;
            color: #1976d2;
            border-left: 4px solid #2196f3;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        /* Dice Section */
        .current-player {
            background: linear-gradient(135deg, #f39c12 0%, #d68910 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
        }

        .dice-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }

        .dice {
            width: clamp(80px, 22vw, 100px);
            height: clamp(80px, 22vw, 100px);
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(35px, 10vw, 50px);
            font-weight: bold;
            color: white;
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.1s;
        }

        .dice:active { transform: scale(0.95); }
        .dice.red { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .dice.yellow { background: linear-gradient(135deg, #f39c12 0%, #d68910 100%); }

        .dice.rolling {
            animation: roll 0.5s ease-in-out;
        }

        @keyframes roll {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(90deg) scale(0.9); }
            50% { transform: rotate(180deg) scale(1.1); }
            75% { transform: rotate(270deg) scale(0.9); }
        }

        .result {
            text-align: center;
            font-size: 2em;
            font-weight: bold;
            color: #333;
            margin: 20px 0;
        }

        .result.robber {
            color: #e74c3c;
            animation: pulse 0.5s;
        }

        @keyframes pulse {
            50% { transform: scale(1.1); }
        }

        .distribution {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            min-height: 80px;
        }

        .distribution h3 {
            color: #495057;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .distribution-item {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            max-width: 300px;
            margin: 10px auto;
            display: block;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: scale(0.98);
        }

        /* Map Section */
        .map-form {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            color: #495057;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 1em;
        }

        .tile-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .tile-item {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tile-info {
            flex: 1;
        }

        .tile-delete {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        /* Score Section */
        .score-board {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
        }

        .player-score {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .player-score.winner {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            animation: celebrate 1s infinite;
        }

        @keyframes celebrate {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .score-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }

        .score-btn {
            width: 40px;
            height: 40px;
            padding: 0;
            font-size: 1.2em;
            border-radius: 50%;
            min-width: unset;
        }

        .score-display {
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            flex: 1;
        }

        .special-cards {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .special-card {
            flex: 1;
            padding: 8px;
            background: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            font-size: 0.85em;
            transition: all 0.3s;
        }

        .special-card.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* Setup Screen */
        .setup-screen {
            padding: 20px;
            text-align: center;
        }

        .setup-screen h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .player-count-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .player-count-btn {
            padding: 12px 20px;
            background: white;
            border: 3px solid #3498db;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            color: #3498db;
            cursor: pointer;
        }

        .player-count-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .player-inputs {
            margin: 20px 0;
        }

        .player-input {
            margin: 10px 0;
        }

        .player-input input {
            width: 100%;
            max-width: 300px;
            padding: 12px;
            border: 2px solid #3498db;
            border-radius: 8px;
            font-size: 1em;
        }

        .hidden {
            display: none !important;
        }

        /* Resource Colors */
        .resource-wood { background-color: #8b4513; color: white; }
        .resource-brick { background-color: #cd5c5c; color: white; }
        .resource-wheat { background-color: #f0e68c; color: #333; }
        .resource-sheep { background-color: #90ee90; color: #333; }
        .resource-ore { background-color: #808080; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Setup Screen -->
        <div class="setup-screen" id="setupScreen">
            <h1>üé≤ „Ç´„Çø„É≥ „Ç≤„Éº„É†„Éû„Çπ„Çø„Éº</h1>
            <h2>„Éó„É¨„Ç§„É§„ÉºË®≠ÂÆö</h2>
            <p>„Éó„É¨„Ç§„É§„Éº‰∫∫Êï∞„ÇíÈÅ∏ÊäûÔºö</p>
            <div class="player-count-selector">
                <button class="player-count-btn" onclick="selectPlayerCount(2, this)">2‰∫∫</button>
                <button class="player-count-btn" onclick="selectPlayerCount(3, this)">3‰∫∫</button>
                <button class="player-count-btn selected" onclick="selectPlayerCount(4, this)">4‰∫∫</button>
                <button class="player-count-btn" onclick="selectPlayerCount(5, this)">5‰∫∫</button>
                <button class="player-count-btn" onclick="selectPlayerCount(6, this)">6‰∫∫</button>
            </div>
            <div class="player-inputs" id="playerInputs"></div>
            <button onclick="startGame()">üéÆ „Ç≤„Éº„É†ÈñãÂßã</button>
        </div>

        <!-- Main Game Screen -->
        <div id="gameScreen" class="hidden">
            <!-- Header -->
            <div class="header">
                <h1>üé≤ „Ç´„Çø„É≥ „Ç≤„Éº„É†„Éû„Çπ„Çø„Éº</h1>
                <button class="voice-toggle" id="voiceToggle" onclick="toggleVoice()">üîá Èü≥Â£∞OFF</button>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('play')">Play</button>
                <button class="tab" onclick="switchTab('map')">Map</button>
                <button class="tab" onclick="switchTab('score')">Score</button>
            </div>

            <!-- Play Tab -->
            <div class="tab-content active" id="playTab">
                <div class="current-player" id="currentPlayer"></div>
                <div class="dice-container">
                    <div class="dice red" id="dice1" onclick="rollDice()">?</div>
                    <div class="dice yellow" id="dice2" onclick="rollDice()">?</div>
                </div>
                <div class="result" id="result">‚Äî</div>
                <div class="distribution" id="distribution">
                    <h3>Ë≥áÊ∫êÈÖçÂ∏É</h3>
                    <p style="color:#6c757d;">„Çµ„Ç§„Ç≥„É≠„ÇíÊåØ„Å£„Å¶„Åè„Å†„Åï„ÅÑ</p>
                </div>

                <!-- Score Ranking -->
                <div style="background:#f8f9fa;border-radius:10px;padding:15px;margin:20px 0;">
                    <h3 style="margin-bottom:10px;color:#495057;">üèÜ „Çπ„Ç≥„Ç¢„É©„É≥„Ç≠„É≥„Ç∞</h3>
                    <div id="playScoreRanking"></div>
                </div>

                <div class="voice-status" style="background:#e8f5e9;border:2px solid #4caf50;">
                    üé§ Èü≥Â£∞ÂÖ•Âäõ Â∏∏ÊôÇON - „Äå„Çµ„Ç§„Ç≥„É≠„Äç„ÄåÊåØ„Çã„Äç„Åæ„Åü„ÅØ„ÄåÁï™Âè∑ÔºãË≥áÊ∫êÔºã„Éó„É¨„Ç§„É§„ÉºÔºãÁ®ÆÈ°û„Äç„ÅßÁôªÈå≤
                </div>
                <button onclick="rollDice()">„Çµ„Ç§„Ç≥„É≠„ÇíÊåØ„Çã</button>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
                    <button onclick="previousPlayer()" style="background:#95a5a6;">‚¨ÖÔ∏è Ââç„ÅÆ‰∫∫</button>
                    <button onclick="nextPlayer()" style="background:#6c757d;">Ê¨°„ÅÆ‰∫∫ ‚û°Ô∏è</button>
                </div>
                <button onclick="showPlayerSettings()" style="background:#e67e22;margin-top:10px;">‚öôÔ∏è „Éó„É¨„Ç§„É§„ÉºË®≠ÂÆö</button>
            </div>

            <!-- Map Tab -->
            <div class="tab-content" id="mapTab">
                <h2 style="margin-bottom:15px;">ÂúüÂú∞ÁôªÈå≤</h2>
                <div class="map-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Êï∞Â≠ó</label>
                            <select id="tileNumber">
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ë≥áÊ∫ê</label>
                            <select id="tileResource">
                                <option value="wood">Êú®</option>
                                <option value="brick">Âúü</option>
                                <option value="wheat">È∫¶</option>
                                <option value="sheep">Áæä</option>
                                <option value="ore">Áü≥</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>„Éó„É¨„Ç§„É§„Éº</label>
                            <select id="tilePlayer"></select>
                        </div>
                        <div class="form-group">
                            <label>Á®ÆÈ°û</label>
                            <select id="tileType">
                                <option value="settlement">ÈñãÊãìÂú∞</option>
                                <option value="city">ÈÉΩÂ∏Ç</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="addTile()">‚ûï ÂúüÂú∞„ÇíËøΩÂä†</button>
                    <div class="voice-help" style="background:#e8f5e9;border:2px solid #4caf50;">
                        üé§ Èü≥Â£∞ÂÖ•Âäõ Â∏∏ÊôÇON<br>
                        üì¢ ‰æã: „Äå8Áï™„ÄÅÊú®„ÄÅ„Éó„É¨„Ç§„É§„Éº1„ÄÅÈñãÊãìÂú∞„Äç
                    </div>
                </div>
                <h3 style="margin-top:20px;margin-bottom:10px;">ÁôªÈå≤Ê∏à„ÅøÂúüÂú∞</h3>
                <div class="tile-list" id="tileList"></div>
            </div>

            <!-- Score Tab -->
            <div class="tab-content" id="scoreTab">
                <h2 style="margin-bottom:15px;">„Çπ„Ç≥„Ç¢„Éú„Éº„Éâ</h2>
                <div class="score-board" id="scoreBoard"></div>
                <button onclick="resetScores()" style="background:#e74c3c;margin-top:20px;">„Çπ„Ç≥„Ç¢„É™„Çª„ÉÉ„Éà</button>
            </div>
        </div>
    </div>

    <script>
        // Game State
        let players = [];
        let currentPlayerIndex = 0;
        let playerCount = 4;
        let tiles = [];
        let scores = {};
        let voiceEnabled = false;
        let isRolling = false;
        let recognition = null;
        let voiceRecognitionActive = false;

        // Resource Names
        const resources = {
            wood: { name: 'Êú®', color: '#8b4513' },
            brick: { name: 'Âúü', color: '#cd5c5c' },
            wheat: { name: 'È∫¶', color: '#f0e68c' },
            sheep: { name: 'Áæä', color: '#90ee90' },
            ore: { name: 'Áü≥', color: '#808080' }
        };

        // Initialize
        function initPlayerSetup() {
            selectPlayerCount(4);
        }

        function selectPlayerCount(count, target = null) {
            playerCount = count;
            document.querySelectorAll('.player-count-btn').forEach((btn, index) => {
                btn.classList.remove('selected');
                if (!target && index === 2) btn.classList.add('selected');
            });
            if (target) target.classList.add('selected');

            // Load saved player names from localStorage
            const savedPlayers = JSON.parse(localStorage.getItem('catanPlayers') || '{}');
            const savedColors = JSON.parse(localStorage.getItem('catanPlayerColors') || '{}');

            const playerInputsDiv = document.getElementById('playerInputs');
            playerInputsDiv.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const playerKey = `player${i + 1}`;
                const savedName = savedPlayers[playerKey] || '';
                const savedColor = savedColors[playerKey] || '#667eea';

                const inputDiv = document.createElement('div');
                inputDiv.className = 'player-input';
                inputDiv.innerHTML = `
                    <div style="display:flex;gap:10px;align-items:center;">
                        <input type="color" id="color${i + 1}" value="${savedColor}"
                               style="width:50px;height:40px;border:none;border-radius:5px;cursor:pointer;">
                        <input type="text" id="player${i + 1}"
                               placeholder="„Éó„É¨„Ç§„É§„Éº${i + 1}"
                               value="${savedName}"
                               onfocus="if(this.value===this.placeholder) this.value='';"
                               style="flex:1;">
                    </div>
                `;
                playerInputsDiv.appendChild(inputDiv);
            }
        }

        function startGame() {
            players = [];
            const playerColors = {};
            const savedPlayers = {};

            for (let i = 0; i < playerCount; i++) {
                const inputVal = document.getElementById(`player${i + 1}`).value.trim();
                const name = inputVal || `„Éó„É¨„Ç§„É§„Éº${i + 1}`;
                const color = document.getElementById(`color${i + 1}`).value;

                players.push(name);
                playerColors[name] = color;

                // Save to localStorage
                savedPlayers[`player${i + 1}`] = inputVal; // Save actual input (might be empty)
                savedPlayers[name] = color;
            }

            // Save player names and colors
            localStorage.setItem('catanPlayers', JSON.stringify(savedPlayers));
            localStorage.setItem('catanPlayerColors', JSON.stringify({
                ...Object.fromEntries(Object.keys(savedPlayers).filter(k => k.startsWith('player')).map((k, i) => [k, document.getElementById(`color${i + 1}`).value]))
            }));

            currentPlayerIndex = 0;

            // Initialize scores
            scores = {};
            players.forEach(player => {
                scores[player] = {
                    manual: 0,
                    longestRoad: false,
                    largestArmy: false,
                    color: playerColors[player]
                };
            });

            // Load tiles from localStorage
            const savedTiles = localStorage.getItem('catanTiles');
            if (savedTiles) tiles = JSON.parse(savedTiles);

            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');

            updatePlayerDropdown();
            updateCurrentPlayer();
            updateScoreBoard();
            speak(`${players[currentPlayerIndex]}„Åï„Çì„ÄÅ„Çµ„Ç§„Ç≥„É≠„ÇíÊåØ„Å£„Å¶„Åè„Å†„Åï„ÅÑÔºÅ`);

            // Start voice recognition
            startVoiceRecognition();
        }

        function updatePlayerDropdown() {
            const select = document.getElementById('tilePlayer');
            select.innerHTML = players.map(p => `<option value="${p}">${p}</option>`).join('');
        }

        function updateCurrentPlayer() {
            const currentColor = scores[players[currentPlayerIndex]]?.color || '#667eea';
            document.getElementById('currentPlayer').textContent = `${players[currentPlayerIndex]}„Åï„Çì„ÅÆ„Å∞„Çì`;
            document.getElementById('currentPlayer').style.background = `linear-gradient(135deg, ${currentColor} 0%, ${adjustColor(currentColor, -20)} 100%)`;
            updatePlayScoreRanking();
        }

        function adjustColor(color, percent) {
            const num = parseInt(color.replace("#",""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 +
                (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255))
                .toString(16).slice(1);
        }

        function updatePlayScoreRanking() {
            const ranking = players.map(player => {
                const score = scores[player];
                const basePoints = tiles.filter(t => t.player === player).reduce((sum, t) =>
                    sum + (t.type === 'city' ? 2 : 1), 0
                );
                const bonusPoints = (score.longestRoad ? 2 : 0) + (score.largestArmy ? 2 : 0);
                const total = basePoints + score.manual + bonusPoints;
                return { player, total, color: score.color };
            }).sort((a, b) => b.total - a.total);

            const rankingHtml = ranking.map((item, index) => `
                <div style="display:flex;justify-content:space-between;padding:8px;margin:5px 0;background:white;border-radius:5px;border-left:4px solid ${item.color};">
                    <span><strong>${index + 1}‰Ωç</strong> ${item.player}</span>
                    <span style="font-weight:bold;color:${item.color};">${item.total}ÁÇπ</span>
                </div>
            `).join('');

            document.getElementById('playScoreRanking').innerHTML = rankingHtml;
        }

        function nextPlayer() {
            currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
            updateCurrentPlayer();
            speak(`${players[currentPlayerIndex]}„Åï„Çì„ÄÅ„Çµ„Ç§„Ç≥„É≠„ÇíÊåØ„Å£„Å¶„Åè„Å†„Åï„ÅÑÔºÅ`);
        }

        // Dice Roll
        function rollDice() {
            if (isRolling) return;
            isRolling = true;

            const dice1 = document.getElementById('dice1');
            const dice2 = document.getElementById('dice2');
            const result = document.getElementById('result');

            dice1.classList.add('rolling');
            dice2.classList.add('rolling');

            let counter = 0;
            const animationInterval = setInterval(() => {
                dice1.textContent = Math.floor(Math.random() * 6) + 1;
                dice2.textContent = Math.floor(Math.random() * 6) + 1;
                counter++;
                if (counter >= 10) clearInterval(animationInterval);
            }, 50);

            setTimeout(() => {
                const value1 = Math.floor(Math.random() * 6) + 1;
                const value2 = Math.floor(Math.random() * 6) + 1;
                const total = value1 + value2;

                dice1.textContent = value1;
                dice2.textContent = value2;
                dice1.classList.remove('rolling');
                dice2.classList.remove('rolling');

                result.textContent = `ÂêàË®à: ${total}`;
                result.classList.toggle('robber', total === 7);

                if (total === 7) {
                    showDistribution(null, true);
                    speak(`${total}„ÄÅÁõóË≥ä„ÅåÊù•„Åæ„Åó„ÅüÔºÅÊâãÊú≠8Êûö‰ª•‰∏ä„ÅØ„Éê„Éº„Çπ„Éà„Åß„Åô`);
                } else {
                    const distribution = calculateDistribution(total);
                    showDistribution(distribution);
                    speakDistribution(total, distribution);
                }

                updatePlayScoreRanking();
                isRolling = false;
            }, 500);
        }

        function calculateDistribution(number) {
            const distribution = {};
            tiles.filter(t => t.number === number).forEach(tile => {
                if (!distribution[tile.player]) distribution[tile.player] = {};
                const resource = tile.resource;
                const amount = tile.type === 'city' ? 2 : 1;
                distribution[tile.player][resource] = (distribution[tile.player][resource] || 0) + amount;
            });
            return distribution;
        }

        function showDistribution(distribution, isRobber = false) {
            const div = document.getElementById('distribution');
            if (isRobber) {
                div.innerHTML = '<h3>Ë≥áÊ∫êÈÖçÂ∏É</h3><div style="color:#e74c3c;font-weight:bold;padding:10px;">‚ö†Ô∏è ÁõóË≥äÔºÅË≥áÊ∫ê„Å™„Åó</div>';
                return;
            }

            let html = '<h3>Ë≥áÊ∫êÈÖçÂ∏É</h3>';
            if (!distribution || Object.keys(distribution).length === 0) {
                html += '<p style="color:#6c757d;">ÈÖçÂ∏É„Å™„Åó</p>';
            } else {
                Object.entries(distribution).forEach(([player, resources]) => {
                    const items = Object.entries(resources).map(([res, amt]) =>
                        `${resources[res].name} √ó${amt}`
                    ).join(', ');
                    html += `<div class="distribution-item"><strong>${player}:</strong> ${items}</div>`;
                });
            }
            div.innerHTML = html;
        }

        function speakDistribution(number, distribution) {
            if (!voiceEnabled) return;

            let text = `${number}Áï™„ÄÇ`;
            if (Object.keys(distribution).length === 0) {
                text += 'ÈÖçÂ∏É„Å™„Åó';
            } else {
                const parts = [];
                Object.entries(distribution).forEach(([player, resources]) => {
                    const items = Object.entries(resources).map(([res, amt]) =>
                        `${resources[res].name}„Çí${amt}„Å§`
                    ).join('„ÄÅ');
                    parts.push(`${player}„Å´${items}`);
                });
                text += parts.join('„ÄÇ');
            }
            speak(text);
        }

        // Map Management
        function addTile() {
            const tile = {
                number: parseInt(document.getElementById('tileNumber').value),
                resource: document.getElementById('tileResource').value,
                player: document.getElementById('tilePlayer').value,
                type: document.getElementById('tileType').value,
                id: Date.now()
            };
            tiles.push(tile);
            saveTiles();
            renderTileList();
            updatePlayScoreRanking();
            updateScoreBoard();
        }

        function deleteTile(id) {
            tiles = tiles.filter(t => t.id !== id);
            saveTiles();
            renderTileList();
            updatePlayScoreRanking();
            updateScoreBoard();
        }

        function renderTileList() {
            const list = document.getElementById('tileList');
            if (tiles.length === 0) {
                list.innerHTML = '<p style="color:#6c757d;text-align:center;padding:20px;">ÂúüÂú∞„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
                return;
            }
            list.innerHTML = tiles.map(tile => `
                <div class="tile-item">
                    <div class="tile-info">
                        <strong>${tile.number}</strong> - ${resources[tile.resource].name}
                        (${tile.player} / ${tile.type === 'city' ? 'ÈÉΩÂ∏Ç' : 'ÈñãÊãìÂú∞'})
                    </div>
                    <button class="tile-delete" onclick="deleteTile(${tile.id})">ÂâäÈô§</button>
                </div>
            `).join('');
        }

        function saveTiles() {
            localStorage.setItem('catanTiles', JSON.stringify(tiles));
        }

        // Score Management
        function updateScoreBoard() {
            const board = document.getElementById('scoreBoard');
            board.innerHTML = players.map(player => {
                const score = scores[player];
                const basePoints = tiles.filter(t => t.player === player).reduce((sum, t) =>
                    sum + (t.type === 'city' ? 2 : 1), 0
                );
                const bonusPoints = (score.longestRoad ? 2 : 0) + (score.largestArmy ? 2 : 0);
                const total = basePoints + score.manual + bonusPoints;
                const isWinner = total >= 10;

                return `
                    <div class="player-score ${isWinner ? 'winner' : ''}">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <strong style="font-size:1.2em;">${player}</strong>
                            ${isWinner ? '<span style="font-size:1.5em;">üèÜ WINNER!</span>' : ''}
                        </div>
                        <div class="score-display">${total}ÁÇπ</div>
                        <div style="font-size:0.85em;color:#6c757d;margin:5px 0;">
                            Âü∫Êú¨:${basePoints} / ÊâãÂãï:${score.manual} / „Éú„Éº„Éä„Çπ:${bonusPoints}
                        </div>
                        <div class="score-controls">
                            <button class="score-btn" onclick="adjustScore('${player}', -1)">‚àí</button>
                            <span>ÊâãÂãïË™øÊï¥</span>
                            <button class="score-btn" onclick="adjustScore('${player}', 1)">+</button>
                        </div>
                        <div class="special-cards">
                            <div class="special-card ${score.longestRoad ? 'active' : ''}"
                                 onclick="toggleSpecial('${player}', 'longestRoad')">
                                ÊúÄÈï∑‰∫§ÊòìË∑Ø +2
                            </div>
                            <div class="special-card ${score.largestArmy ? 'active' : ''}"
                                 onclick="toggleSpecial('${player}', 'largestArmy')">
                                ÊúÄÂ§ßÈ®éÂ£´Âäõ +2
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Check for winner
            const winner = players.find(p => {
                const score = scores[p];
                const base = tiles.filter(t => t.player === p).reduce((s, t) => s + (t.type === 'city' ? 2 : 1), 0);
                const bonus = (score.longestRoad ? 2 : 0) + (score.largestArmy ? 2 : 0);
                return base + score.manual + bonus >= 10;
            });

            if (winner) speak(`${winner}„Åï„Çì„ÅåÂãùÂà©„Åó„Åæ„Åó„ÅüÔºÅ„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ`);
        }

        function adjustScore(player, amount) {
            scores[player].manual = Math.max(0, scores[player].manual + amount);
            updateScoreBoard();
        }

        function toggleSpecial(player, type) {
            // Only one player can have each special card
            if (!scores[player][type]) {
                players.forEach(p => scores[p][type] = false);
            }
            scores[player][type] = !scores[player][type];
            updateScoreBoard();
        }

        function resetScores() {
            if (!confirm('„Çπ„Ç≥„Ç¢„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) return;
            players.forEach(p => {
                scores[p] = { manual: 0, longestRoad: false, largestArmy: false };
            });
            updateScoreBoard();
        }

        // Voice
        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            const btn = document.getElementById('voiceToggle');
            btn.textContent = voiceEnabled ? 'üîä Èü≥Â£∞ON' : 'üîá Èü≥Â£∞OFF';
            btn.classList.toggle('on', voiceEnabled);
        }

        function speak(text) {
            if (!voiceEnabled || !('speechSynthesis' in window)) return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ja-JP';
            window.speechSynthesis.speak(utterance);
        }

        // Voice Recognition
        function initVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'ja-JP';
                recognition.continuous = true;
                recognition.interimResults = false;

                recognition.onresult = (event) => {
                    const lastResult = event.results[event.results.length - 1];
                    const transcript = lastResult[0].transcript;
                    handleVoiceInput(transcript);
                };

                recognition.onerror = (event) => {
                    console.error('Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº:', event.error);
                    if (event.error === 'no-speech' || event.error === 'audio-capture') {
                        // Automatically restart
                        setTimeout(() => {
                            if (voiceRecognitionActive) {
                                try { recognition.start(); } catch(e) {}
                            }
                        }, 1000);
                    }
                };

                recognition.onend = () => {
                    // Auto-restart if still active
                    if (voiceRecognitionActive) {
                        setTimeout(() => {
                            try { recognition.start(); } catch(e) {}
                        }, 500);
                    }
                };
            }
        }

        function startVoiceRecognition() {
            if (!recognition) initVoiceRecognition();
            if (recognition && !voiceRecognitionActive) {
                voiceRecognitionActive = true;
                try {
                    recognition.start();
                } catch(e) {
                    console.log('Èü≥Â£∞Ë™çË≠ò„ÅØÊó¢„Å´ÈñãÂßã„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
                }
            }
        }

        function stopVoiceRecognition() {
            voiceRecognitionActive = false;
            if (recognition) {
                try { recognition.stop(); } catch(e) {}
            }
        }

        function handleVoiceInput(text) {
            console.log('Èü≥Â£∞ÂÖ•Âäõ:', text);
            const lowerText = text.toLowerCase();

            // Check for dice roll commands
            if (text.includes('„Çµ„Ç§„Ç≥„É≠') || text.includes('„Åï„ÅÑ„Åì„Çç') ||
                text.includes('ÊåØ„Çã') || text.includes('„Åµ„Çã') ||
                text.includes('„ÉÄ„Ç§„Çπ') || text.includes('„É≠„Éº„É´')) {
                rollDice();
                return;
            }

            // Check for player navigation
            if (text.includes('Ê¨°') || text.includes('„Å§„Åé') || text.includes('„Éç„ÇØ„Çπ„Éà')) {
                nextPlayer();
                return;
            }

            if (text.includes('Ââç') || text.includes('„Åæ„Åà') || text.includes('Êàª') || text.includes('„ÇÇ„Å©')) {
                previousPlayer();
                return;
            }

            // Try to parse as tile registration
            // Format: "Áï™Âè∑„ÄÅË≥áÊ∫ê„ÄÅ„Éó„É¨„Ç§„É§„Éº„ÄÅÁ®ÆÈ°û"
            if (text.includes('Áï™') || /\d+/.test(text)) {
                parseTileInput(text);
                return;
            }
        }

        function parseTileInput(text) {
            // Parse input like "8Áï™„ÄÅÊú®„ÄÅ„Éó„É¨„Ç§„É§„Éº1„ÄÅÈñãÊãìÂú∞"
            try {
                // Remove spaces and split
                const cleaned = text.replace(/\s/g, '');
                const parts = cleaned.split(/„ÄÅ|,|„ÄÇ/);

                console.log('Èü≥Â£∞„Éë„Éº„Çπ:', parts);

                // Extract number (must be 2-12, excluding 7)
                const numberMatch = cleaned.match(/(\d+)/);
                if (!numberMatch) throw new Error('Êï∞Â≠ó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                const number = parseInt(numberMatch[1]);
                if (![2,3,4,5,6,8,9,10,11,12].includes(number)) {
                    throw new Error(`${number}„ÅØÁÑ°Âäπ„Å™Áï™Âè∑„Åß„ÅôÔºà2-6, 8-12„ÅÆ„ÅøÔºâ`);
                }

                // Extract resource from anywhere in the text
                let resource = null;
                const resourceMap = {
                    'Êú®': 'wood', '„Åç': 'wood', '„ÇÇ„Åè': 'wood',
                    'Âúü': 'brick', '„Å§„Å°': 'brick', '„É¨„É≥„Ç¨': 'brick', '„Çå„Çì„Åå': 'brick',
                    'È∫¶': 'wheat', '„ÇÄ„Åé': 'wheat', '„É†„ÇÆ': 'wheat', 'Â∞èÈ∫¶': 'wheat',
                    'Áæä': 'sheep', '„Å≤„Å§„Åò': 'sheep', '„Éí„ÉÑ„Ç∏': 'sheep',
                    'Áü≥': 'ore', '„ÅÑ„Åó': 'ore', '„Ç§„Ç∑': 'ore', 'Èâ±Áü≥': 'ore'
                };
                for (const [key, value] of Object.entries(resourceMap)) {
                    if (cleaned.includes(key)) {
                        resource = value;
                        break;
                    }
                }
                if (!resource) throw new Error('Ë≥áÊ∫ê„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„ÇìÔºàÊú®/Âúü/È∫¶/Áæä/Áü≥Ôºâ');

                // Extract player - check all parts
                let playerName = null;
                for (const part of parts) {
                    // Direct match
                    for (const player of players) {
                        if (part.includes(player) || part.includes(player.replace('„Éó„É¨„Ç§„É§„Éº', ''))) {
                            playerName = player;
                            break;
                        }
                    }
                    if (playerName) break;

                    // Number match (e.g., "1" means „Éó„É¨„Ç§„É§„Éº1)
                    const playerMatch = part.match(/(\d+)/);
                    if (playerMatch) {
                        const idx = parseInt(playerMatch[1]) - 1;
                        if (idx >= 0 && idx < players.length) {
                            playerName = players[idx];
                            break;
                        }
                    }
                }
                if (!playerName) {
                    // Default to current player
                    playerName = players[currentPlayerIndex];
                    console.log('„Éó„É¨„Ç§„É§„ÉºÊú™ÊåáÂÆö„ÄÅÁèæÂú®„ÅÆ„Éó„É¨„Ç§„É§„Éº„Çí‰ΩøÁî®:', playerName);
                }

                // Extract type (default: settlement)
                let type = 'settlement';
                if (cleaned.includes('ÈÉΩÂ∏Ç') || cleaned.includes('„Å®„Åó') || cleaned.includes('„Éà„Ç∑')) {
                    type = 'city';
                }

                // Set form values and add tile
                document.getElementById('tileNumber').value = number;
                document.getElementById('tileResource').value = resource;
                document.getElementById('tilePlayer').value = playerName;
                document.getElementById('tileType').value = type;

                // Add tile
                addTile();
                speak(`${number}Áï™„ÄÅ${resources[resource].name}„ÇíÁôªÈå≤„Åó„Åæ„Åó„Åü`);
                console.log(`‚úÖ ÁôªÈå≤ÊàêÂäü: ${number}Áï™ ${resources[resource].name} ${playerName} ${type}`);
            } catch (error) {
                console.error('Èü≥Â£∞ÂÖ•Âäõ„Ç®„É©„Éº:', error.message);
                speak(error.message);
            }
        }

        // previousPlayer function
        function previousPlayer() {
            currentPlayerIndex = (currentPlayerIndex - 1 + players.length) % players.length;
            updateCurrentPlayer();
            speak(`${players[currentPlayerIndex]}„Åï„Çì„ÄÅ„Çµ„Ç§„Ç≥„É≠„ÇíÊåØ„Å£„Å¶„Åè„Å†„Åï„ÅÑÔºÅ`);
        }

        // Player settings
        function showPlayerSettings() {
            const settingsHtml = players.map((player, index) => {
                const color = scores[player]?.color || '#667eea';
                return `
                    <div style="margin:15px 0;padding:10px;background:white;border-radius:8px;">
                        <div style="display:flex;gap:10px;align-items:center;">
                            <input type="color" id="editColor${index}" value="${color}"
                                   style="width:50px;height:40px;border:none;border-radius:5px;">
                            <input type="text" id="editPlayer${index}" value="${player}"
                                   style="flex:1;padding:10px;border:2px solid #dee2e6;border-radius:5px;font-size:1em;">
                        </div>
                    </div>
                `;
            }).join('');

            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:white;padding:20px;border-radius:15px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;">
                    <h2 style="margin-bottom:15px;">‚öôÔ∏è „Éó„É¨„Ç§„É§„ÉºË®≠ÂÆö</h2>
                    ${settingsHtml}
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:20px;">
                        <button onclick="cancelPlayerSettings()" style="background:#95a5a6;">„Ç≠„É£„É≥„Çª„É´</button>
                        <button onclick="savePlayerSettings()">‰øùÂ≠ò</button>
                    </div>
                </div>
            `;
            modal.id = 'playerSettingsModal';
            document.body.appendChild(modal);
        }

        function savePlayerSettings() {
            const oldPlayers = [...players];
            const newPlayers = [];
            const playerColors = {};

            for (let i = 0; i < players.length; i++) {
                const newName = document.getElementById(`editPlayer${i}`).value.trim() || players[i];
                const newColor = document.getElementById(`editColor${i}`).value;
                newPlayers.push(newName);
                playerColors[newName] = newColor;
            }

            // Update players array and scores
            players = newPlayers;
            const newScores = {};
            for (let i = 0; i < oldPlayers.length; i++) {
                const oldPlayer = oldPlayers[i];
                const newPlayer = newPlayers[i];
                newScores[newPlayer] = {
                    ...scores[oldPlayer],
                    color: playerColors[newPlayer]
                };
            }
            scores = newScores;

            // Update tiles with new player names
            tiles = tiles.map(tile => {
                const oldIndex = oldPlayers.indexOf(tile.player);
                if (oldIndex !== -1) {
                    return { ...tile, player: newPlayers[oldIndex] };
                }
                return tile;
            });
            saveTiles();

            // Update UI
            updatePlayerDropdown();
            updateCurrentPlayer();
            updateScoreBoard();
            renderTileList();

            cancelPlayerSettings();
            speak('„Éó„É¨„Ç§„É§„ÉºË®≠ÂÆö„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
        }

        function cancelPlayerSettings() {
            const modal = document.getElementById('playerSettingsModal');
            if (modal) modal.remove();
        }

        // Tab Switching
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');

            if (tab === 'map') renderTileList();
            if (tab === 'score') updateScoreBoard();
        }

        // Initialize on load
        window.addEventListener('load', initPlayerSetup);
    </script>
</body>
</html>
